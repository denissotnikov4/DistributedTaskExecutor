# Архитектура системы

## Обзор

Система построена на основе **Clean Architecture** и состоит из двух основных компонентов:

1. **TaskService** - API сервис для управления задачами
2. **WorkerService** - Фоновый сервис для выполнения задач

## Структура TaskService

### Domain Layer (TaskManagement.Domain)

**Ответственность:** Доменные модели и бизнес-правила

- `Entities/Task.cs` - Доменная модель задачи
- `Entities/TaskStatus.cs` - Перечисление статусов задачи
- `Interfaces/ITaskRepository.cs` - Интерфейс репозитория задач
- `Interfaces/ITaskMessageQueue.cs` - Интерфейс очереди сообщений

**Принципы:**
- Не зависит от других слоев
- Содержит только бизнес-логику
- Не содержит зависимостей от инфраструктуры

### Application Layer (TaskManagement.Application)

**Ответственность:** Use cases и бизнес-логика приложения

- `Commands/` - Команды (CQRS)
  - `CreateTaskCommand` - Создание задачи
  - `RetryTaskCommand` - Повторное выполнение задачи
- `Queries/` - Запросы (CQRS)
  - `GetTaskByIdQuery` - Получение задачи по ID
  - `GetAllTasksQuery` - Получение всех задач
- `DTOs/` - Объекты передачи данных
- `Mappings/` - AutoMapper профили
- `Validators/` - FluentValidation валидаторы

**Технологии:**
- MediatR для CQRS
- AutoMapper для маппинга
- FluentValidation для валидации

**Принципы:**
- Зависит только от Domain
- Содержит use cases приложения
- Не зависит от инфраструктуры

### Infrastructure Layer (TaskManagement.Infrastructure)

**Ответственность:** Реализация инфраструктурных зависимостей

- `Data/TaskDbContext.cs` - DbContext для Entity Framework
- `Repositories/TaskRepository.cs` - Реализация репозитория
- `Messaging/RabbitMqTaskMessageQueue.cs` - Реализация очереди сообщений
- `Services/TaskExpirationService.cs` - Фоновый сервис для проверки истекших задач
- `DependencyInjection.cs` - Регистрация зависимостей

**Технологии:**
- Entity Framework Core с PostgreSQL
- RabbitMQ для очередей сообщений
- Serilog для логирования

**Принципы:**
- Реализует интерфейсы из Domain
- Содержит все зависимости от внешних библиотек
- Изолирован от бизнес-логики

### API Layer (TaskManagement.API)

**Ответственность:** Точка входа, HTTP endpoints

- `Controllers/TasksController.cs` - REST API для управления задачами
- `Controllers/AuthController.cs` - Аутентификация
- `Program.cs` - Конфигурация приложения

**Технологии:**
- ASP.NET Core Web API
- Swagger/OpenAPI
- JWT Bearer аутентификация
- Serilog для логирования

**Принципы:**
- Тонкий слой, только маршрутизация
- Зависит от Application и Infrastructure
- Не содержит бизнес-логики

## Структура WorkerService

### TaskExecutor.Worker

**Ответственность:** Выполнение задач из очереди

- `Worker.cs` - Фоновый сервис для обработки задач
- `Program.cs` - Конфигурация приложения

**Функциональность:**
1. Подключение к RabbitMQ
2. Потребление задач из очереди
3. Выполнение задач с контролем TTL
4. Отправка результатов в очередь результатов
5. Обновление статуса задач в базе данных

**Особенности:**
- Поддержка нескольких экземпляров (горизонтальное масштабирование)
- Автоматическая отмена задач при истечении TTL
- Обработка ошибок с повторными попытками

## Поток данных

### Создание задачи

```
Client → API → CreateTaskCommand → TaskRepository → Database
                              ↓
                    RabbitMQ Queue
```

### Выполнение задачи

```
RabbitMQ Queue → Worker → Process Task → Update Database
                              ↓
                    RabbitMQ Result Queue
```

### Мониторинг задачи

```
Client → API → GetTaskQuery → TaskRepository → Database
```

## Компоненты системы

### База данных (PostgreSQL)

- Хранение задач и их статусов
- Индексы для быстрого поиска
- Миграции для управления схемой

### Очередь сообщений (RabbitMQ)

- **task_queue** - Очередь задач для выполнения
- **task_result_queue** - Очередь результатов выполнения
- **task_exchange** - Exchange для маршрутизации

### Фоновые сервисы

1. **TaskExpirationService** - Проверяет истекшие задачи каждые 30 секунд
2. **Worker** - Выполняет задачи из очереди

## Безопасность

### Аутентификация

- JWT Bearer токены
- Настраиваемые ключи и параметры
- Валидация токенов на каждом запросе

### Валидация

- FluentValidation для входных данных
- Проверка TTL (максимум 24 часа)
- Проверка количества повторных попыток

## Масштабирование

### Горизонтальное масштабирование

1. **API сервис:**
   - Можно запустить несколько экземпляров
   - Балансировка нагрузки через load balancer
   - Общая база данных

2. **Worker сервис:**
   - Можно запустить несколько экземпляров
   - RabbitMQ автоматически распределяет задачи
   - Каждый воркер обрабатывает одну задачу за раз

### Вертикальное масштабирование

- Увеличение ресурсов серверов
- Настройка connection pooling для PostgreSQL
- Настройка prefetch count для RabbitMQ

## Отказоустойчивость

### Механизмы

1. **Повторные попытки:**
   - Настраиваемое количество попыток
   - Автоматический retry при ошибках

2. **TTL контроль:**
   - Автоматическая отмена истекших задач
   - Фоновый сервис для проверки

3. **Очередь сообщений:**
   - Сохранение задач в RabbitMQ
   - Гарантия доставки

4. **База данных:**
   - Транзакции для целостности данных
   - Индексы для производительности

## Мониторинг

### Логирование

- Serilog для структурированного логирования
- Логи в файлы и консоль
- Разные уровни логирования

### Метрики

- Количество задач по статусам
- Время выполнения задач
- Количество ошибок

### Отслеживание

- Worker ID для идентификации воркера
- Временные метки для всех операций
- Сохранение результатов и ошибок

## Развертывание

### Docker

- Отдельные образы для API и Worker
- Docker Compose для инфраструктуры
- Легкое масштабирование

### Kubernetes (планируется)

- Deployment для API
- Deployment для Worker
- Service для балансировки
- ConfigMap для конфигурации
- Secrets для чувствительных данных

## Будущие улучшения

1. **Prometheus метрики** - Интеграция с Prometheus
2. **Distributed Tracing** - OpenTelemetry для отслеживания
3. **Health Checks** - Endpoints для проверки здоровья
4. **Rate Limiting** - Ограничение частоты запросов
5. **Caching** - Redis для кэширования
6. **Event Sourcing** - Сохранение всех событий

