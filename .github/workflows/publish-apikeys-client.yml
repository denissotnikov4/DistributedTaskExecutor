name: Publish ApiKeys.Client (NuGet)

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Package version (example: 1.0.0)'
        required: true
        default: '0.0.0'

jobs:
  publish:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x

      - name: Determine version
        id: version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            # Extract version from tag (apikeys-client-v1.0.0 -> 1.0.0)
            VERSION=${GITHUB_REF#refs/tags/apikeys-client-v}
            echo "version=$VERSION" >> $GITHUB_OUTPUT
          fi

      - name: Restore
        run: dotnet restore ./src/ApiKeysService/ApiKeys.Client/ApiKeys.Client.csproj

      - name: Build
        run: dotnet build ./src/ApiKeysService/ApiKeys.Client/ApiKeys.Client.csproj --configuration Release --no-restore

      - name: Pack
        run: dotnet pack ./src/ApiKeysService/ApiKeys.Client/ApiKeys.Client.csproj --configuration Release --no-build -p:PackageVersion=${{ steps.version.outputs.version }} -o out

      - name: Configure NuGet for GitHub Packages
        run: |
          dotnet nuget add source https://nuget.pkg.github.com/${{ github.repository_owner }}/index.json \
            --name github \
            --username ${{ github.repository_owner }} \
            --password ${{ secrets.GITHUB_TOKEN }} \
            --store-password-in-clear-text

      - name: Push to GitHub Packages
        run: dotnet nuget push "out/*.nupkg" --source github --api-key ${{ secrets.GITHUB_TOKEN }} --skip-duplicate
